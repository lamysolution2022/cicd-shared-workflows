# 1차 장애주입 + DLQ 리허설 설계서 v1

- 제출 ID: `61a07b6bb340414abed25716e638f5d3`
- 요청 ID: `61a07b6bb340414abed25716e638f5d3`
- 작성일: 2026-02-19
- 작성자: Platform Engineer (CI/CD Owner)
- 범위: Outbox -> RabbitMQ 장애주입 시나리오 및 DLQ 운영 리허설 체크리스트(실행 제외)

## 1) 리허설 목표
- 브로커 장애 시 메시지 유실/중복 정책 검증 기준 확정
- 재시도 -> 실패 전이 -> DLQ 적재 -> 재처리 흐름 점검 항목 표준화
- 복구시간(RTO) 및 운영 알림 체계 측정 항목 명세

## 2) 장애주입 시나리오 목록
### F1. 브로커 지연 증가
- 주입 방식: 네트워크 지연 200ms/500ms/1s 단계 증가
- 검증 포인트: publisher confirm 지연, outbox backlog 증가율, 재시도 횟수

### F2. 브로커 일시 중단
- 주입 방식: RabbitMQ stop 1분/3분
- 검증 포인트: outbox retry 동작, 재기동 후 drain 완료시간, 메시지 순서 보존 여부

### F3. 브로커 재기동
- 주입 방식: 강제 restart
- 검증 포인트: 연결 복구 시간, 재전송 성공률, 중복 소비 여부

### F4. 소비자 처리 실패(비재시도 대상)
- 주입 방식: poison message 투입
- 검증 포인트: DLQ 전이 정확성, 원본 큐 재적재 방지

## 3) Outbox 전달 경로 검증 항목
- Outbox 상태 전이: `PENDING -> SENT -> CONFIRMED` / 실패 시 `FAILED`
- 재시도 정책: backoff(1s, 5s, 15s), 최대 시도 횟수 5회
- 실패 전이 정책: 최대 시도 초과 시 DLQ 전이 플래그 설정
- 복구 측정: 브로커 복구 시점부터 backlog 0 도달까지 시간

## 4) DLQ 리허설 체크리스트
| 체크 항목 | 확인 기준 | 완료 여부 |
|---|---|---|
| DLQ 라우팅 키/바인딩 확인 | poison message가 DLQ로 100% 전이 | [ ] |
| 재처리 잡 실행 | DLQ -> 원본 큐 재투입 성공 | [ ] |
| 중복 방지 검증 | idempotency key 기반 중복 차단 | [ ] |
| 알림 발송 확인 | DLQ 적재 임계치 초과 시 알림 | [ ] |
| 운영 대시보드 반영 | backlog/DLQ depth 지표 노출 | [ ] |
| 복구 시나리오 종료 기록 | 종료 시각/잔여 건수 기록 | [ ] |

## 5) 운영 체크리스트
1. 장애 시작 시각/주입 파라미터 기록
2. outbox backlog, publish 실패율, retry 횟수 수집
3. 브로커 복구 후 drain 완료 시각 기록
4. DLQ 적재 건수/재처리 성공률 기록
5. 사고 보고 템플릿 작성(원인/영향/재발방지)

## 6) 판정 기준(초안)
- 유실률: 0%
- 중복률: 0.1% 이하
- 복구 시간(RTO): 10분 이내
- DLQ 재처리 성공률: 99% 이상

## 7) 운영 원칙
- Coordination 단일 채널
- Owner 직접 소통 금지
